<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>C√£o Amigo - Gerenciamento de Ado√ß√µes</title>
    
    <script src="https://cdn.tailwindcss.com"></script> 
    
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
        /* Vari√°veis e CSS customizado */
        :root {
            --color-primary: #10B981; /* Emerald 500 */
            --color-secondary: #FBBF24; /* Amber 500 */
            --color-background: #F9FAFB; /* Gray-50 */
        }
        body {
            font-family: 'Inter', sans-serif;
            background-color: var(--color-background);
        }
        .card {
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
        }
        .tab-active {
            border-bottom: 3px solid var(--color-primary);
            color: var(--color-primary);
            font-weight: 600;
        }
        .btn-primary {
            background-color: var(--color-primary);
            transition: background-color 0.15s;
        }
        .btn-primary:hover {
            background-color: #059669; /* Emerald 600 */
        }
        .fade-in {
            animation: fadeIn 0.3s ease-in-out;
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
    </style>
</head>
<body class="bg-gray-50 text-gray-800">
    <div class="min-h-screen flex flex-col">
        
        <header class="sticky top-0 bg-white shadow-sm z-20">
            <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
                <div class="flex justify-between h-16 items-center">
                    <h1 class="text-2xl font-extrabold text-emerald-600 flex items-center gap-2">
                        üê∂ <span class="hidden sm:inline">C√£o Amigo</span>
                    </h1>
                    <nav id="main-nav" class="flex space-x-1 sm:space-x-4"></nav>
                </div>
            </div>
        </header>

        <main class="flex-grow max-w-7xl mx-auto w-full px-4 sm:px-6 lg:px-8 py-8">
            <div id="message-container"></div>
            
            <div id="loading-indicator" class="hidden fixed inset-0 bg-gray-900 bg-opacity-30 flex items-center justify-center z-50 backdrop-blur-sm">
                <div class="bg-white p-4 rounded-full shadow-xl">
                    <div class="animate-spin rounded-full h-10 w-10 border-4 border-emerald-100 border-t-emerald-600"></div>
                </div>
            </div>

            <div id="content-container" class="fade-in"></div>
        </main>
        
        <footer class="bg-white border-t border-gray-200 mt-auto">
            <div class="max-w-7xl mx-auto py-6 px-4 overflow-hidden sm:px-6 lg:px-8">
                <p class="text-center text-base text-gray-400">
                    &copy; 2024 C√£o Amigo. Todos os direitos reservados.
                </p>
            </div>
        </footer>
    </div>

    <div id="confirmation-modal" class="hidden fixed inset-0 bg-gray-900 bg-opacity-75 flex items-center justify-center z-50">
        <div class="bg-white p-6 rounded-lg shadow-2xl max-w-sm w-full">
            <h3 class="text-lg font-bold mb-4">Confirma√ß√£o</h3>
            <p id="modal-message" class="text-gray-600 mb-6"></p>
            <div class="flex justify-end space-x-3">
                <button id="modal-cancel-btn" class="px-4 py-2 text-gray-600 bg-gray-200 rounded-md hover:bg-gray-300 transition">Cancelar</button>
                <button id="modal-confirm-btn" class="px-4 py-2 text-white bg-red-600 rounded-md hover:bg-red-700 transition">Confirmar</button>
            </div>
        </div>
    </div>

    <script>
// =========================================================================
// CONFIGURA√á√ïES INICIAIS E ESTADO
// =========================================================================

const API_BASE_URL = "https://apicaoamigo-entrega.onrender.com/api/v1"; 

// ESTADO GLOBAL
let state = {
    currentEntity: 'cachorros', 
    currentPage: 'list', 
    data: [], 
    selectedId: null, 
};

// Mapeamento das Entidades e Campos
const entitiesMap = {
    'cachorros': { 
        title: 'Cachorros', 
        endpoint: '/cachorros',
        // ESTADO: 'mock' for√ßa o uso de dados de demonstra√ß√£o (ignora API)
        status: 'mock', 
        fields: {
            nome: { type: 'text', label: 'Nome', required: true, maxlength: 100, minlength: 2 },
            dataDeNascimento: { type: 'date', label: 'Data de Nascimento', required: false },
            localDeResgate: { type: 'text', label: 'Local de Resgate', required: true, maxlength: 80 },
            descricaoHistoria: { type: 'textarea', label: 'Hist√≥ria', required: false, maxlength: 2000 },
            temperamentoPrincipal: { type: 'text', label: 'Temperamento Principal', required: false, maxlength: 200 },
            habilidadesEspeciais: { type: 'text', label: 'Habilidades Especiais', required: false },
        }
    },
    'adocoes': { 
        title: 'Ado√ß√µes', 
        endpoint: '/adocoes',
        status: 'online', // ESTADO: 'online' tenta usar a API
        fields: {
            dataSolicitacao: { type: 'date', label: 'Data da Solicita√ß√£o', required: true },
            justificativa: { type: 'textarea', label: 'Justificativa', required: true, maxlength: 2000 },
            status: { type: 'select', label: 'Status', required: true, options: ['PENDENTE', 'APROVADA', 'REJEITADA'] },
            cachorroId: { type: 'text', label: 'ID Cachorro', required: false }, 
        }
    },
    'racas': { 
        title: 'Ra√ßas', 
        endpoint: '/racas',
        status: 'online', // ESTADO: 'online' tenta usar a API
        fields: {
            nome: { type: 'text', label: 'Nome da Ra√ßa', required: true, maxlength: 50, minlength: 2 },
            descricao: { type: 'textarea', label: 'Descri√ß√£o', required: false, maxlength: 200 },
        }
    }
};

// =========================================================================
// UTILS E UI 
// =========================================================================

const showLoading = (show) => {
    document.getElementById('loading-indicator').classList.toggle('hidden', !show);
};

const showMessage = (message, type = 'success') => {
    const container = document.getElementById('message-container');
    const color = type === 'success' ? 'bg-green-100 border-green-400 text-green-700' : 
                  type === 'error' ? 'bg-red-100 border-red-400 text-red-700' : 
                  'bg-blue-100 border-blue-400 text-blue-700';
    container.innerHTML = `
        <div class="p-3 mb-4 rounded-lg border ${color} flex justify-between items-center" role="alert">
            <span>${message}</span>
            <button onclick="document.getElementById('message-container').innerHTML = ''" class="ml-4 font-bold leading-none text-2xl">&times;</button>
        </div>
    `;
    if (type !== 'error') {
        setTimeout(() => { container.innerHTML = ''; }, 5000);
    }
};

const formatDate = (dateString) => {
    if (!dateString) return 'N/A';
    try {
        const date = new Date(dateString);
        const localDate = new Date(date.getTime() + date.getTimezoneOffset() * 60000);
        return localDate.toLocaleDateString('pt-BR');
    } catch {
        return dateString;
    }
};

const showConfirmationModal = (message) => {
    return new Promise(resolve => {
        const modal = document.getElementById('confirmation-modal');
        document.getElementById('modal-message').textContent = message;
        modal.classList.remove('hidden');

        const confirmBtn = document.getElementById('modal-confirm-btn');
        const cancelBtn = document.getElementById('modal-cancel-btn');

        const cleanup = () => {
            modal.classList.add('hidden');
            confirmBtn.onclick = null;
            cancelBtn.onclick = null;
        };

        confirmBtn.onclick = () => {
            cleanup();
            resolve(true);
        };
        cancelBtn.onclick = () => {
            cleanup();
            resolve(false);
        };
    });
};

// =========================================================================
// MOCK DATA 
// =========================================================================

const generateMockData = (entity) => {
    switch (entity) {
        case 'cachorros':
            return [
                { id: 101, nome: 'Rex', dataDeNascimento: '2023-01-15', localDeResgate: 'Pra√ßa Central', ficha: { descricaoHistoria: 'Resgatado ap√≥s enchente.', temperamentoPrincipal: 'D√≥cil' } },
                { id: 102, nome: 'Luna', dataDeNascimento: '2022-05-20', localDeResgate: 'Abrigo Municipal', ficha: { descricaoHistoria: 'Cachorra de porte pequeno, muito brincalhona.', temperamentoPrincipal: 'Ativa' } },
            ];
        case 'adocoes':
            return [
                { id: 201, dataSolicitacao: '2025-10-01', justificativa: 'Temos um grande quintal.', status: 'PENDENTE', cachorro: { id: 101, nome: 'Rex' }, racas: [{ nome: 'SRD' }] },
                { id: 202, dataSolicitacao: '2025-09-15', justificativa: 'Amamos c√£es pequenos.', status: 'APROVADA', cachorro: { id: 102, nome: 'Luna' }, racas: [{ nome: 'Poodle' }] },
            ];
        case 'racas':
            return [
                { id: 301, nome: 'Labrador', descricao: 'C√£o de fam√≠lia, muito amig√°vel.' },
                { id: 302, nome: 'SRD', descricao: 'Sem ra√ßa definida.' },
            ];
        default:
            return [];
    }
};

// =========================================================================
// API INTERA√á√ïES
// =========================================================================

const fetchWithRetry = async (url, options = {}, retries = 3) => {
    for (let i = 0; i < retries; i++) {
        try {
            const response = await fetch(url, options);
            if (!response.ok) {
                const errorBody = await response.text(); 
                throw new Error(`HTTP ${response.status}: ${errorBody.substring(0, 100)}...`);
            }
            return response;
        } catch (error) {
            console.error(`Tentativa ${i + 1} falhou para ${url}:`, error);
            if (i === retries - 1) throw error;
            const delay = Math.pow(2, i) * 1000;
            await new Promise(res => setTimeout(res, delay));
        }
    }
};

const fetchEntityList = async (entity, query = '') => {
    const config = entitiesMap[entity];
    
    // --- L√ìGICA DE MODO MOCK FOR√áADO ---
    if (config.status === 'mock') {
        showLoading(true);
        const mockData = generateMockData(entity);
        if (query) {
            state.data = mockData.filter(item => 
                Object.values(item).some(val => 
                    String(val).toUpperCase().includes(query.toUpperCase())
                )
            );
        } else {
            state.data = mockData;
        }
        showMessage(`Lista de ${config.title} carregada. (Modo Mock For√ßado)`, 'info');
        showLoading(false);
        return state.data;
    }
    // ------------------------------------

    let finalUrl = `${API_BASE_URL}${config.endpoint}`;
    
    if (query) {
        finalUrl = `${finalUrl}/search?q=${encodeURIComponent(query)}&page=0&size=20`; 
    }

    showLoading(true);
    try {
        const response = await fetchWithRetry(finalUrl, { method: 'GET' });
        
        if (response.status === 204) return []; 

        const realData = await response.json();
        
        const dataList = realData.content && Array.isArray(realData.content) ? realData.content : 
                         Array.isArray(realData) ? realData : 
                         (realData.Adocoes || realData.Racas || realData.Cachorros || []); 

        state.data = dataList;
        showMessage(`Lista de ${config.title} carregada.`, 'success');
        return dataList;
    } catch (error) {
        // Fallback para Mock (para Adocoes e Racas, caso a API caia)
        console.warn(`API offline ou erro (${entity}). Usando Mock Data.`, error);
        
        const mockData = generateMockData(entity);
        if (query) {
            state.data = mockData.filter(item => 
                Object.values(item).some(val => 
                    String(val).toUpperCase().includes(query.toUpperCase())
                )
            );
        } else {
            state.data = mockData;
        }
        showMessage(`üö® Usando dados de demonstra√ß√£o. API offline ou erro: ${error.message}`, 'error');
        return state.data;
    } finally {
        showLoading(false);
    }
};

const saveEntity = async (entity, data, id = null) => {
    const config = entitiesMap[entity];
    
    // Se a entidade est√° em modo mock, simule a opera√ß√£o
    if (config.status === 'mock') {
        showMessage(`Simulando sucesso: ${config.title} foi ${id ? 'editado' : 'criado'} (Modo Mock).`, 'info');
        return true; 
    }

    const endpoint = config.endpoint + (id ? `/${id}` : '');
    const url = `${API_BASE_URL}${endpoint}`;
    const method = id ? 'PUT' : 'POST';

    showLoading(true);
    try {
        const payload = {...data};
        if (!id) delete payload.id; 
        
        const idempotencyKey = `key-${entity}-${id || Date.now()}-${Math.random().toString(36).substring(2, 9)}`; 

        const response = await fetchWithRetry(url, {
            method: method,
            headers: { 
                'Content-Type': 'application/json',
                'X-Idempotency-Key': idempotencyKey 
            }, 
            body: JSON.stringify(payload)
        });
        
        if (response.status === 200) {
             showMessage(`${config.title} (${id || 'novo'}) processado. (Replay Idempotente)`, 'info');
        } else {
            showMessage(`${config.title} ${id ? 'atualizado' : 'criado'} com sucesso!`, 'success');
        }
        return true;
    } catch (error) {
        console.error(`Erro ao salvar ${entity}:`, error);
        showMessage(`Erro ao salvar: ${error.message}. Verifique o console.`, 'error');
        return false;
    } finally {
        showLoading(false);
    }
};

const deleteEntity = async (entity, id) => {
    const config = entitiesMap[entity];
    
    // Se a entidade est√° em modo mock, simule a opera√ß√£o
    if (config.status === 'mock') {
        if (!await showConfirmationModal(`Simulando DELETE: Tem certeza que deseja deletar o ID ${id} de ${config.title}?`)) {
            return false;
        }
        showMessage(`Simula√ß√£o de DELETE de ID ${id} bem-sucedida (Modo Mock).`, 'info');
        // Para simular a remo√ß√£o da lista em Mock, voc√™ precisaria de l√≥gica extra
        showPage('list', entity); 
        return true;
    }

    const url = `${API_BASE_URL}${config.endpoint}/${id}`;
    
    if (!await showConfirmationModal(`Tem certeza que deseja deletar o registro ID ${id} de ${config.title}?`)) {
        return false;
    }

    showLoading(true);
    try {
        const idempotencyKey = `key-delete-${entity}-${id}-${Date.now()}`; 
        
        await fetchWithRetry(url, { 
            method: 'DELETE',
            headers: { 
                'X-Idempotency-Key': idempotencyKey 
            }, 
        });
        showMessage(`Registro deletado com sucesso (ID: ${id}).`, 'success');
        return true;
    } catch (error) {
        console.error(`Erro ao deletar:`, error);
        showMessage(`Erro ao deletar: ${error.message}. Pode estar em uso (Ra√ßas) ou n√£o existir.`, 'error');
        return false;
    } finally {
        showLoading(false);
        showPage('list', entity); 
    }
};

// =========================================================================
// RENDERIZA√á√ÉO DE UI (Mantida a mesma)
// =========================================================================

const renderHeader = () => {
    const nav = document.getElementById('main-nav');
    nav.innerHTML = ''; 

    Object.keys(entitiesMap).forEach(key => {
        const config = entitiesMap[key];
        const isActive = state.currentEntity === key;
        
        const button = document.createElement('button');
        button.className = `px-3 py-2 text-sm uppercase transition ${
            isActive 
                ? 'tab-active text-emerald-600' 
                : 'text-gray-500 hover:text-gray-900'
        }`;
        button.textContent = config.title;
        button.onclick = () => showPage('list', key);
        nav.appendChild(button);
    });
};

const renderListItem = (item) => {
    const currentEntity = state.currentEntity;
    
    let primaryInfo = item.nome || item.dataSolicitacao || item.id;
    let secondaryInfo = '';
    
    if (currentEntity === 'cachorros') {
        primaryInfo = item.nome || `ID: ${item.id}`;
        secondaryInfo = `Resgate: ${item.localDeResgate || 'N/A'}`;
        if (item.dataDeNascimento) {
            secondaryInfo += ` | Nasc.: ${formatDate(item.dataDeNascimento)}`;
        }
    } else if (currentEntity === 'adocoes') {
        primaryInfo = `Status: ${item.status || 'N/A'}`;
        secondaryInfo = `C√£o: ${item.cachorro?.nome || 'ID:' + item.cachorro?.id || 'N/A'}`;
        if (item.dataSolicitacao) {
             secondaryInfo += ` | Data: ${formatDate(item.dataSolicitacao)}`;
        }
    } else if (currentEntity === 'racas') {
        primaryInfo = item.nome || `ID: ${item.id}`;
        secondaryInfo = item.descricao ? item.descricao.substring(0, 50) + '...' : 'Sem descri√ß√£o';
    }

    return `
        <div class="flex items-center justify-between p-4 bg-white border-b border-gray-100 last:border-b-0">
            <div class="flex-grow">
                <p class="text-base font-semibold text-gray-700">${primaryInfo}</p>
                <p class="text-sm text-gray-500">ID: ${item.id} | ${secondaryInfo}</p>
            </div>
            <div class="flex space-x-2">
                <button data-id="${item.id}" class="edit-btn p-2 rounded-full text-emerald-600 hover:bg-emerald-100 transition" title="Editar">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.232 5.232l3.536 3.536m-2.036-5.036a2.5 2.5 0 113.536 3.536L6.5 21.036H3v-3.572L16.732 3.732z"></path></svg>
                </button>
                <button data-id="${item.id}" class="delete-btn p-2 rounded-full text-red-600 hover:bg-red-100 transition" title="Deletar">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path></svg>
                </button>
            </div>
        </div>
    `;
};

const renderListPage = () => {
    const container = document.getElementById('content-container');
    const config = entitiesMap[state.currentEntity];
    
    let listHtml = state.data.map(renderListItem).join('');
    
    if (state.data.length === 0) {
        listHtml = `<p class="text-center text-gray-500 py-10">Nenhum registro encontrado para ${config.title}.</p>`;
    }

    container.innerHTML = `
        <div class="mb-6 flex justify-between items-center">
            <h2 class="text-3xl font-bold text-gray-900">Lista de ${config.title} ${config.status === 'mock' ? '(MOCK)' : ''}</h2>
            <button id="new-entity-btn" class="btn-primary text-white font-medium py-2 px-4 rounded-lg shadow-md hover:shadow-lg transition flex items-center gap-2">
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6"></path></svg>
                Novo ${config.title.slice(0, -1)}
            </button>
        </div>
        
        <div class="mb-6">
            <div class="flex space-x-2">
                <input type="text" id="search-input" placeholder="Buscar por palavra-chave..." class="flex-grow p-2 border border-gray-300 rounded-lg shadow-sm focus:ring-emerald-500 focus:border-emerald-500">
                <button id="search-btn" class="btn-primary text-white font-medium py-2 px-4 rounded-lg shadow-md hover:shadow-lg transition">Buscar</button>
            </div>
        </div>

        <div class="card bg-white rounded-xl overflow-hidden divide-y divide-gray-100">
            ${listHtml}
        </div>
    `;

    document.getElementById('new-entity-btn').onclick = () => showPage('form');
    document.getElementById('search-btn').onclick = handleSearch;
    document.getElementById('search-input').addEventListener('keypress', (e) => {
        if (e.key === 'Enter') handleSearch();
    });
    
    document.querySelectorAll('.delete-btn').forEach(btn => {
        btn.onclick = (e) => deleteEntity(state.currentEntity, e.currentTarget.dataset.id);
    });
    document.querySelectorAll('.edit-btn').forEach(btn => {
        btn.onclick = (e) => {
            state.selectedId = e.currentTarget.dataset.id;
            showPage('form');
        };
    });
};

const renderFormPage = () => {
    const container = document.getElementById('content-container');
    const config = entitiesMap[state.currentEntity];
    
    const isEditing = state.selectedId !== null;
    const itemToEdit = isEditing ? state.data.find(d => String(d.id) === String(state.selectedId)) : {};
    
    if (state.currentEntity === 'cachorros' && itemToEdit && itemToEdit.ficha) {
        Object.assign(itemToEdit, itemToEdit.ficha);
    }
    
    let formFieldsHtml = isEditing ? `<input type="hidden" name="id" value="${itemToEdit.id || ''}">` : '';

    Object.keys(config.fields).forEach(key => {
        const field = config.fields[key];
        const currentValue = itemToEdit ? itemToEdit[key] : '';
        const required = field.required ? 'required' : '';
        const placeholder = field.label;

        let inputElement;

        if (field.type === 'textarea') {
            inputElement = `
                <textarea 
                    name="${key}" 
                    id="${key}" 
                    rows="4" 
                    placeholder="${placeholder}" 
                    class="p-3 w-full border border-gray-300 rounded-lg focus:ring-emerald-500 focus:border-emerald-500" 
                    ${required}
                >${currentValue || ''}</textarea>
            `;
        } else if (field.type === 'select' && field.options) {
            const optionsHtml = field.options.map(option => `
                <option value="${option}" ${currentValue === option ? 'selected' : ''}>${option}</option>
            `).join('');
            inputElement = `
                <select 
                    name="${key}" 
                    id="${key}" 
                    class="p-3 w-full border border-gray-300 rounded-lg focus:ring-emerald-500 focus:border-emerald-500" 
                    ${required}
                >
                    <option value="">-- Selecione --</option>
                    ${optionsHtml}
                </select>
            `;
        } else {
            inputElement = `
                <input 
                    type="${field.type}" 
                    name="${key}" 
                    id="${key}" 
                    value="${field.type === 'date' && currentValue ? currentValue.split('T')[0] : currentValue || ''}" 
                    placeholder="${placeholder}" 
                    class="p-3 w-full border border-gray-300 rounded-lg shadow-sm focus:ring-emerald-500 focus:border-emerald-500" 
                    ${required}
                    ${field.maxlength ? `maxlength="${field.maxlength}"` : ''}
                    ${field.minlength ? `minlength="${field.minlength}"` : ''}
                />
            `;
        }

        formFieldsHtml += `
            <div class="mb-4">
                <label for="${key}" class="block text-sm font-medium text-gray-700 mb-1">
                    ${field.label} ${field.required ? '<span class="text-red-500">*</span>' : ''}
                </label>
                ${inputElement}
            </div>
        `;
    });

    container.innerHTML = `
        <div class="mb-6 flex justify-between items-center">
            <h2 class="text-3xl font-bold text-gray-900">${isEditing ? 'Editar' : 'Novo'} ${config.title.slice(0, -1)}</h2>
            <button id="back-to-list-btn" class="text-gray-500 hover:text-gray-700 transition flex items-center gap-1">
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 19l-7-7m0 0l7-7m-7 7h18"></path></svg>
                Voltar √† Lista
            </button>
        </div>
        
        <div class="card bg-white rounded-xl p-6 lg:p-8">
            <form id="entity-form">
                ${formFieldsHtml}
                <div class="mt-6 pt-4 border-t">
                    <button type="submit" class="btn-primary w-full text-white font-bold py-3 px-4 rounded-lg shadow-md hover:shadow-lg transition">
                        ${isEditing ? 'Salvar Altera√ß√µes' : 'Criar Registro'}
                    </button>
                </div>
            </form>
        </div>
    `;
    
    document.getElementById('back-to-list-btn').onclick = () => showPage('list');
    document.getElementById('entity-form').addEventListener('submit', handleFormSubmit);
};


// =========================================================================
// HANDLERS E CONTROLE DE NAVEGA√á√ÉO
// =========================================================================

const handleSearch = () => {
    const query = document.getElementById('search-input').value;
    fetchEntityList(state.currentEntity, query).then(renderListPage); 
};

const handleFormSubmit = async (e) => {
    e.preventDefault();
    const formData = new FormData(e.target);
    const data = {};
    
    for (let [key, value] of formData.entries()) {
        if (key === 'id' && !value) continue;
        data[key] = value;
    }

    if (state.currentEntity === 'cachorros') {
        const fichaKeys = ['descricaoHistoria', 'temperamentoPrincipal', 'habilidadesEspeciais'];
        const ficha = {};
        fichaKeys.forEach(k => { ficha[k] = data[k] || null; delete data[k]; });
        data.ficha = ficha; 
    }
    
    if (state.currentEntity === 'adocoes') {
        if (data.cachorroId) {
            data.cachorro = { id: parseInt(data.cachorroId) }; 
            delete data.cachorroId;
        }
        data.racas = data.racas || []; 
    }

    const success = await saveEntity(state.currentEntity, data, data.id);
    if (success) {
        state.selectedId = null;
        showPage('list'); 
    }
};

const showPage = async (page, entity = state.currentEntity) => {
    state.currentPage = page;
    state.currentEntity = entity;
    
    if (page === 'list' || (page === 'form' && !state.selectedId)) state.selectedId = null; 
    
    renderHeader();
    
    const container = document.getElementById('content-container');
    container.classList.remove('fade-in');
    
    if (page === 'list') {
        await fetchEntityList(state.currentEntity);
        container.classList.add('fade-in');
        renderListPage();
    } else if (page === 'form') {
        container.classList.add('fade-in');
        renderFormPage(); 
    }
    window.scrollTo(0, 0); 
};

// =========================================================================
// INICIALIZA√á√ÉO
// =========================================================================

window.onload = () => {
    showPage('list', 'cachorros'); 
};
    </script>
</body>
</html>
