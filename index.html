<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>C√£o Amigo - Gerenciamento de Ado√ß√µes</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --color-primary: #10B981; /* Emerald */
            --color-secondary: #FBBF24; /* Amber */
            --color-background: #F9FAFB; /* Gray-50 */
        }
        body {
            font-family: 'Inter', sans-serif;
            background-color: var(--color-background);
        }
        .card {
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
        }
        .tab-active {
            border-bottom: 3px solid var(--color-primary);
            color: var(--color-primary);
            font-weight: 600;
        }
        .btn-primary {
            background-color: var(--color-primary);
            transition: background-color 0.15s;
        }
        .btn-primary:hover {
            background-color: #059669; /* Emerald 600 */
        }
    </style>
    <script>
        // CONFIGURA√á√ïES
        const API_BASE_URL = "https://apicaoamigo-entrega.onrender.com/api/v1"; 

        // ESTADO GLOBAL
        let state = {
            currentEntity: 'cachorros', // 'cachorros', 'adocoes', 'racas'
            currentPage: 'list', // 'list', 'form'
            data: [], // Dados da lista
            selectedId: null, // ID para edi√ß√£o/visualiza√ß√£o
        };

        const entitiesMap = {
            'cachorros': { 
                title: 'Cachorros', 
                endpoint: '/cachorros',
                fields: {
                    nome: { type: 'text', label: 'Nome', required: true, maxlength: 100, minlength: 2 },
                    dataDeNascimento: { type: 'date', label: 'Data de Nascimento', required: false },
                    localDeResgate: { type: 'text', label: 'Local de Resgate', required: true, maxlength: 80 },
                    // Campos da FichaCachorro
                    descricaoHistoria: { type: 'textarea', label: 'Hist√≥ria', required: false, maxlength: 2000 },
                    temperamentoPrincipal: { type: 'text', label: 'Temperamento Principal', required: false, maxlength: 200 },
                    habilidadesEspeciais: { type: 'text', label: 'Habilidades Especiais', required: false },
                }
            },
            'adocoes': { 
                title: 'Ado√ß√µes', 
                endpoint: '/adocoes',
                fields: {
                    dataSolicitacao: { type: 'date', label: 'Data da Solicita√ß√£o', required: true },
                    justificativa: { type: 'textarea', label: 'Justificativa', required: true, maxlength: 2000 },
                    status: { type: 'select', label: 'Status', required: true, options: ['PENDENTE', 'APROVADA', 'REJEITADA'] },
                    cachorroId: { type: 'text', label: 'ID Cachorro', required: false }, 
                }
            },
            'racas': { 
                title: 'Ra√ßas', 
                endpoint: '/racas',
                fields: {
                    nome: { type: 'text', label: 'Nome da Ra√ßa', required: true, maxlength: 50, minlength: 2 },
                    descricao: { type: 'textarea', label: 'Descri√ß√£o', required: false, maxlength: 200 },
                }
            }
        };

        // UTILS
        const showMessage = (message, type = 'success') => {
            const container = document.getElementById('message-container');
            const color = type === 'success' ? 'bg-green-100 border-green-400 text-green-700' : 
                          type === 'error' ? 'bg-red-100 border-red-400 text-red-700' : 
                          'bg-blue-100 border-blue-400 text-blue-700';
            container.innerHTML = `
                <div class="p-3 mb-4 rounded-lg border ${color}" role="alert">
                    ${message}
                </div>
            `;
            setTimeout(() => { container.innerHTML = ''; }, 5000);
        };

        const formatDate = (dateString) => {
            if (!dateString) return 'N/A';
            try {
                // Tenta ajustar o fuso hor√°rio ou usa apenas a parte da data
                const date = new Date(dateString);
                return date.toLocaleDateString('pt-BR');
            } catch {
                return dateString;
            }
        };

        const fetchWithRetry = async (url, options = {}, retries = 3) => {
            for (let i = 0; i < retries; i++) {
                try {
                    const response = await fetch(url, options);
                    if (!response.ok) {
                        const errorText = await response.text();
                        throw new Error(`HTTP error! Status: ${response.status}. ${errorText}`);
                    }
                    return response;
                } catch (error) {
                    console.error(`Attempt ${i + 1} failed for ${url}:`, error);
                    if (i === retries - 1) throw error;
                    const delay = Math.pow(2, i) * 1000;
                    await new Promise(res => setTimeout(res, delay));
                }
            }
        };

        // API INTERA√á√ïES
        const fetchEntityList = async (entity, query = '') => {
            let finalUrl = `${API_BASE_URL}${entitiesMap[entity].endpoint}`;
            
            // Se houver busca, ajusta a URL
            if (query) {
                // Nota: Ajuste o par√¢metro 'q' conforme o seu backend espera (ex: 'nome' ou 'term')
                finalUrl = `${finalUrl}/search?q=${encodeURIComponent(query)}&page=0&size=20`;
            }

            document.getElementById('loading-indicator').classList.remove('hidden');
            try {
                const response = await fetchWithRetry(finalUrl, { method: 'GET' });
                // Verifica se o conte√∫do existe antes de parsear
                if (response.status === 204) return []; 

                const realData = await response.json();
                
                // Tratamento para Spring Boot Pageable (se vier dentro de 'content')
                if (realData.content && Array.isArray(realData.content)) {
                    state.data = realData.content;
                } else if (Array.isArray(realData)) {
                    state.data = realData;
                } else {
                    state.data = [];
                    console.warn("Formato de dados inesperado:", realData);
                }

                showMessage(`Lista de ${entitiesMap[entity].title} carregada.`, 'success');
                return state.data;
            } catch (error) {
                console.error(`Erro ao buscar ${entity}:`, error);
                
                // Fallback para Mock em caso de erro
                const mockData = generateMockData(entity);
                if (query) {
                    state.data = mockData.filter(item => 
                        Object.values(item).some(val => 
                            String(val).toUpperCase().includes(query.toUpperCase())
                        )
                    );
                } else {
                    state.data = mockData;
                }
                showMessage(`Usando dados de demonstra√ß√£o (API offline ou erro: ${error.message})`, 'error');
                return state.data;
            } finally {
                document.getElementById('loading-indicator').classList.add('hidden');
            }
        };

        const saveEntity = async (entity, data, id = null) => {
            const endpoint = entitiesMap[entity].endpoint + (id ? `/${id}` : '');
            const url = `${API_BASE_URL}${endpoint}`;
            const method = id ? 'PUT' : 'POST';

            document.getElementById('loading-indicator').classList.remove('hidden');
            try {
                // Clona o objeto para n√£o alterar o original do form
                const payload = {...data};
                if (!id) delete payload.id; 
                
                await fetchWithRetry(url, {
                    method: method,
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });
                
                showMessage(`${entitiesMap[entity].title} ${id ? 'atualizado' : 'criado'} com sucesso!`, 'success');
                return true;
            } catch (error) {
                console.error(`Erro ao salvar ${entity}:`, error);
                showMessage(`Erro ao salvar: ${error.message}.`, 'error');
                return false;
            } finally {
                document.getElementById('loading-indicator').classList.add('hidden');
            }
        };

        const deleteEntity = async (entity, id) => {
            const url = `${API_BASE_URL}${entitiesMap[entity].endpoint}/${id}`;
            
            if (!await showConfirmationModal(`Tem certeza que deseja deletar o ID ${id}?`)) {
                return false;
            }

            document.getElementById('loading-indicator').classList.remove('hidden');
            try {
                await fetchWithRetry(url, { method: 'DELETE' });
                showMessage(`Registro deletado com sucesso.`, 'success');
                return true;
            } catch (error) {
                console.error(`Erro ao deletar:`, error);
                showMessage(`Erro ao deletar: ${error.message}.`, 'error');
                return false;
            } finally {
                document.getElementById('loading-indicator').classList.add('hidden');
                showPage('list', entity);
            }
        };

        // MODAL CUSTOMIZADO
        const showConfirmationModal = (message) => {
            return new Promise(resolve => {
                const modalHtml = `
                    <div id="custom-modal" class="fixed inset-0 bg-gray-900 bg-opacity-50 flex items-center justify-center z-50">
                        <div class="bg-white p-6 rounded-xl card max-w-sm w-full mx-4">
                            <h3 class="text-xl font-bold text-gray-800 mb-4">Confirma√ß√£o</h3>
                            <p class="text-gray-600 mb-6">${message}</p>
                            <div class="flex justify-end space-x-3">
                                <button id="modal-cancel" class="px-4 py-2 text-gray-700 bg-gray-200 rounded-lg hover:bg-gray-300 transition">Cancelar</button>
                                <button id="modal-confirm" class="px-4 py-2 text-white bg-red-600 rounded-lg hover:bg-red-700 transition">Confirmar</button>
                            </div>
                        </div>
                    </div>
                `;
                document.body.insertAdjacentHTML('beforeend', modalHtml);
                const modal = document.getElementById('custom-modal');
                
                document.getElementById('modal-cancel').onclick = () => { modal.remove(); resolve(false); };
                document.getElementById('modal-confirm').onclick = () => { modal.remove(); resolve(true); };
            });
        };

        // RENDERIZA√á√ÉO
        const renderHeader = () => {
            const nav = document.getElementById('main-nav');
            nav.innerHTML = `
                ${['cachorros', 'adocoes', 'racas'].map(key => `
                    <button onclick="showPage('list', '${key}')"
                        class="px-4 py-4 sm:py-2 transition duration-150 ease-in-out hover:bg-gray-50 rounded-md
                        ${state.currentEntity === key ? 'tab-active' : 'text-gray-500'}"
                    >
                        ${entitiesMap[key].title}
                    </button>
                `).join('')}
            `;
        };

        const renderListPage = () => {
            const container = document.getElementById('content-container');
            const entityConfig = entitiesMap[state.currentEntity];
            
            container.innerHTML = `
                <div class="flex flex-col sm:flex-row justify-between items-center mb-6 p-4 bg-white rounded-xl card">
                    <h2 class="text-2xl font-bold text-gray-700 mb-4 sm:mb-0">Lista de ${entityConfig.title}</h2>
                    <div class="flex flex-col sm:flex-row space-y-2 sm:space-y-0 sm:space-x-2 w-full sm:w-auto">
                        <input id="search-input" type="text" placeholder="Buscar..." 
                               class="p-2 border border-gray-300 rounded-lg w-full sm:w-64 focus:ring-emerald-500 focus:border-emerald-500">
                        <div class="flex space-x-2">
                            <button onclick="handleSearch()" class="btn-primary text-white p-2 rounded-lg font-semibold flex-grow sm:flex-grow-0">Buscar</button>
                            <button onclick="showPage('form')" class="btn-primary text-white p-2 rounded-lg font-semibold flex-grow sm:flex-grow-0 whitespace-nowrap">+ Novo</button>
                        </div>
                    </div>
                </div>

                <div id="entity-list" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                    ${state.data && state.data.length > 0 ? state.data.map(item => renderListItem(item)).join('') : `
                        <div class="col-span-full p-10 text-center bg-white rounded-xl card text-gray-500">
                            Nenhum registro encontrado.
                        </div>
                    `}
                </div>
            `;
            
            document.getElementById('search-input').addEventListener('keypress', (e) => {
                if (e.key === 'Enter') handleSearch();
            });

            document.querySelectorAll('.delete-btn').forEach(btn => {
                btn.onclick = (e) => deleteEntity(state.currentEntity, e.currentTarget.dataset.id);
            });
            document.querySelectorAll('.edit-btn').forEach(btn => {
                btn.onclick = (e) => {
                    state.selectedId = e.currentTarget.dataset.id;
                    showPage('form');
                };
            });
        };

        const renderListItem = (item) => {
            let details = '';
            let icon = '';
            let mainField = item.id;

            switch (state.currentEntity) {
                case 'cachorros':
                    mainField = item.nome || `ID ${item.id}`;
                    details = `<p class="text-sm text-gray-600">Resgate: ${item.localDeResgate || '-'}</p>`;
                    icon = `<div class="p-3 bg-yellow-200 rounded-full text-yellow-700">üê∂</div>`;
                    break;
                case 'adocoes':
                    mainField = `Solicita√ß√£o ${item.id}`;
                    details = `<p class="text-sm text-gray-600">Data: ${formatDate(item.dataSolicitacao)}</p>
                               <p class="text-sm text-gray-600">Cachorro: ${item.cachorro?.nome || 'ID ' + (item.cachorro?.id || '?')}</p>
                               <span class="text-xs font-bold px-2 py-0.5 rounded ${item.status === 'APROVADA' ? 'bg-green-200 text-green-800' : 'bg-yellow-200 text-yellow-800'}">${item.status}</span>`;
                    icon = `<div class="p-3 bg-blue-200 rounded-full text-blue-700">üìù</div>`;
                    break;
                case 'racas':
                    mainField = item.nome;
                    details = `<p class="text-sm text-gray-600 truncate">${item.descricao || ''}</p>`;
                    icon = `<div class="p-3 bg-purple-200 rounded-full text-purple-700">üß¨</div>`;
                    break;
            }

            return `
                <div class="bg-white p-5 rounded-xl card hover:shadow-lg transition duration-200 flex items-start space-x-4">
                    ${icon}
                    <div class="flex-grow overflow-hidden">
                        <h3 class="text-xl font-semibold text-gray-800 truncate">${mainField}</h3>
                        ${details}
                    </div>
                    <div class="flex space-x-1">
                        <button data-id="${item.id}" class="edit-btn p-2 text-white bg-blue-500 hover:bg-blue-600 rounded-lg">‚úèÔ∏è</button>
                        <button data-id="${item.id}" class="delete-btn p-2 text-white bg-red-500 hover:bg-red-600 rounded-lg">üóëÔ∏è</button>
                    </div>
                </div>
            `;
        };
        
        const renderFormPage = () => {
            const container = document.getElementById('content-container');
            const entityConfig = entitiesMap[state.currentEntity];
            const isEditing = state.selectedId !== null;
            const currentItem = isEditing ? state.data.find(item => String(item.id) === String(state.selectedId)) : {};
            
            // Prepara√ß√£o dos dados para o form
            let formData = {};
            if (isEditing) {
                if (state.currentEntity === 'cachorros') {
                    formData = { ...currentItem, ...currentItem.ficha };
                } else if (state.currentEntity === 'adocoes') {
                    formData = { ...currentItem };
                    if (currentItem.cachorro) formData.cachorroId = currentItem.cachorro.id;
                } else {
                    formData = { ...currentItem };
                }
            }

            container.innerHTML = `
                <div class="bg-white p-6 sm:p-8 rounded-xl card max-w-2xl mx-auto">
                    <h2 class="text-2xl font-bold text-gray-800 mb-6 border-b pb-2">
                        ${isEditing ? 'Editar' : 'Novo'} ${entityConfig.title.slice(0, -1)}
                    </h2>
                    <form id="entity-form">
                        <input type="hidden" name="id" value="${formData.id || ''}">
                        <div class="grid grid-cols-1 gap-4">
                            ${Object.entries(entityConfig.fields).map(([key, field]) => {
                                const value = formData[key] !== undefined && formData[key] !== null ? formData[key] : '';
                                const baseClass = "w-full p-2 border border-gray-300 rounded-lg focus:ring-emerald-500 focus:border-emerald-500";

                                let inputHtml = '';
                                if (field.type === 'textarea') {
                                    inputHtml = `<textarea id="${key}" name="${key}" rows="3" class="${baseClass}" maxlength="${field.maxlength || ''}" ${field.required ? 'required' : ''}>${value}</textarea>`;
                                } else if (field.type === 'select') {
                                    inputHtml = `
                                        <select id="${key}" name="${key}" class="${baseClass}" ${field.required ? 'required' : ''}>
                                            ${field.options.map(opt => `<option value="${opt}" ${value === opt ? 'selected' : ''}>${opt}</option>`).join('')}
                                        </select>`;
                                } else {
                                    inputHtml = `<input type="${field.type}" id="${key}" name="${key}" value="${value}" class="${baseClass}" maxlength="${field.maxlength || ''}" ${field.required ? 'required' : ''}>`;
                                }

                                return `
                                    <div>
                                        <label for="${key}" class="block text-sm font-medium text-gray-700 mb-1">${field.label} ${field.required ? '<span class="text-red-500">*</span>' : ''}</label>
                                        ${inputHtml}
                                    </div>
                                `;
                            }).join('')}
                        </div>
                        
                        <div class="mt-8 flex justify-end space-x-3">
                            <button type="button" onclick="showPage('list')" class="px-4 py-2 border border-gray-300 text-gray-700 rounded-lg hover:bg-gray-50">Cancelar</button>
                            <button type="submit" class="btn-primary text-white px-6 py-2 rounded-lg font-semibold">Salvar</button>
                        </div>
                    </form>
                </div>
            `;
            document.getElementById('entity-form').addEventListener('submit', handleFormSubmit);
        };

        const handleSearch = () => {
            const query = document.getElementById('search-input').value;
            fetchEntityList(state.currentEntity, query).then(renderListPage);
        };

        const handleFormSubmit = async (e) => {
            e.preventDefault();
            const formData = new FormData(e.target);
            const data = {};
            
            for (let [key, value] of formData.entries()) {
                if (key === 'id' && !value) continue;
                data[key] = value;
            }

            // Tratamento Especial: Cachorros (Ficha aninhada)
            if (state.currentEntity === 'cachorros') {
                const fichaKeys = ['descricaoHistoria', 'temperamentoPrincipal', 'habilidadesEspeciais'];
                const ficha = {};
                fichaKeys.forEach(k => { ficha[k] = data[k] || null; delete data[k]; });
                data.ficha = ficha; 
            }
            
            // Tratamento Especial: Ado√ß√µes (Objeto Cachorro)
            if (state.currentEntity === 'adocoes') {
                if (data.cachorroId) {
                    data.cachorro = { id: parseInt(data.cachorroId) }; 
                    delete data.cachorroId;
                }
                data.racas = []; // Simplifica√ß√£o
            }

            const success = await saveEntity(state.currentEntity, data, data.id);
            if (success) {
                state.selectedId = null;
                showPage('list');
            }
        };

        const showPage = async (page, entity = state.currentEntity) => {
            state.currentPage = page;
            state.currentEntity = entity;
            if (page === 'list' || (page === 'form' && !state.selectedId)) state.selectedId = null; 
            
            renderHeader();
            
            if (page === 'list') {
                await fetchEntityList(state.currentEntity);
                renderListPage();
            } else if (page === 'form') {
                renderFormPage();
            }
            window.scrollTo(0, 0);
        };

        // MOCK DATA
        const generateMockData = (entity) => {
            if (entity === 'cachorros') return [
                { id: 1, nome: 'Thor', dataDeNascimento: '2023-01-15', localDeResgate: 'Pra√ßa', ficha: { descricaoHistoria: 'Resgatado...', temperamentoPrincipal: 'Brincalh√£o' } },
                { id: 2, nome: 'Luna', dataDeNascimento: '2022-05-20', localDeResgate: 'Fazenda', ficha: { descricaoHistoria: 'Calma...', temperamentoPrincipal: 'Calma' } }
            ];
            if (entity === 'adocoes') return [
                { id: 101, dataSolicitacao: '2024-09-28', justificativa: 'Amamos c√£es', status: 'APROVADA', cachorro: { id: 1, nome: 'Thor' } }
            ];
            if (entity === 'racas') return [
                { id: 1, nome: 'Vira-Lata', descricao: 'Mesti√ßo Brasileiro' },
                { id: 2, nome: 'Poodle', descricao: 'Inteligente' }
            ];
            return [];
        };

        window.onload = () => {
            showPage('list', 'cachorros'); 
        };
    </script>
</head>
<body class="bg-gray-50 text-gray-800">
    <div class="min-h-screen flex flex-col">
        <header class="sticky top-0 bg-white shadow-sm z-20">
            <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
                <div class="flex justify-between h-16 items-center">
                    <h1 class="text-2xl font-extrabold text-emerald-600 flex items-center gap-2">
                        üê∂ <span class="hidden sm:inline">C√£o Amigo</span>
                    </h1>
                    <nav id="main-nav" class="flex space-x-1 sm:space-x-4"></nav>
                </div>
            </div>
        </header>

        <main class="flex-grow max-w-7xl mx-auto w-full px-4 sm:px-6 lg:px-8 py-8">
            <div id="message-container"></div>
            
            <div id="loading-indicator" class="hidden fixed inset-0 bg-gray-900 bg-opacity-30 flex items-center justify-center z-50 backdrop-blur-sm">
                <div class="bg-white p-4 rounded-full shadow-xl">
                    <div class="animate-spin rounded-full h-10 w-10 border-4 border-emerald-100 border-t-emerald-600"></div>
                </div>
            </div>

            <div id="content-container" class="fade-in"></div>
        </main>
        
        <footer class="bg-white border-t border-gray-200 mt-auto">
            <div class="max-w-7xl mx-auto py-6 px-4 overflow-hidden sm:px-6 lg:px-8">
                <p class="text-center text-base text-gray-400">
                    &copy; 2024 C√£o Amigo. Todos os direitos reservados.
                </p>
            </div>
        </footer>
    </div>
</body>
</html>
